{#- How to use the user_banner

The content() and script() macro get added to the base.html.

The content() elements will be added at the start of the <body> above the
header in base.html.

The script() elements will be added to the <head> in the base.html. This has
additional CSS and JS files for the banner slide in and out effects.

In those macros are responsible for all checks of the start and end times. Make
sure to use the same date conditionals in the user_banner.content() macro and
the user_banner.script() macro.

This no longer uses env vars set in browse.config or httpd/conf/ng_flask.conf on
production.

Adding an environment var, so we can enable only on gcp.
-#}

{# Banner varaibles - if you just want a default banner #}
{% set BANNER_1_NAME = "birthday" %}
{# Set these variables to a string of YYYYMMDD of the start and end date #}
{% set BANNER_START_1 = 202508140000 %} {#  8/14  start of day#}
{% set BANNER_END_1 = 202508142350 %}{#  8/14 end of day#}
{% set BANNER_1_TITLE = "Happy Birthday to arXiv!" %}
{% set BANNER_1_TEXT = "It's our birthday — woohoo! On August 14th, 1991, the very first paper was submitted to arXiv. That's 34 years of open science! Give today and help support arXiv for many birthdays to come." %}
{% set BANNER_1_BUTTON_TEXT = "Give a gift!" %}
{% set BANNER_1_BUTTON_LINK = "https://info.arxiv.org/about/donate.html" %}

{% set BANNER_2_NAME = "opt-in" %}
{# Set these variables to a string of YYYYMMDD of the start and end date #}
{% set BANNER_START_2 = 202508170000 %} {#  8/18  start of day#}
{% set BANNER_END_2 = 202508192350 %}{#  8/19 end of day#}

{% set SLIDE = True %}

{%- macro banner_1_content(request_datetime) -%}
    {%- set now=request_datetime.strftime("%Y%m%d%H%M")|int -%}

    {%- if now >= BANNER_START_1 and now < BANNER_END_1 -%}
      <aside class="slider-wrapper bps-banner forum blue">
        <a class="close-slider do-close-slider bps-banner" href="#"><img src="{{ url_for('static', filename='images/icons/close-slider.png') }}" alt="close this message"></a>
       <div class="columns">
          <img role="presentation" class="bps-banner-image" src="{{ url_for('static', filename='images/icons/smileybones-pixel.png') }}" alt="arXiv smileybones">
          <div class="copy-donation bps-banner">
            <h2>{{BANNER_1_TITLE}}</h2>
            <p>{{BANNER_1_TEXT}}</p>
          </div>
          <div class="amount-donation bps-banner">
            <div class="donate-cta"><a class="banner_link banner-btn-grad" target="_blank" href="{{BANNER_1_BUTTON_LINK}}"><b>{{BANNER_1_BUTTON_TEXT}}</b></a></div>
          </div>
        </div>
      </aside>
    {%- endif -%}

{%- endmacro -%}

{%- macro banner_2_content(request_datetime) -%}
  {%- set now=request_datetime.strftime("%Y%m%d%H%M")|int -%}
  {%- if now >= BANNER_START_2 and now < BANNER_END_2 -%}
    <aside class="slider-wrapper bps-banner forum">
      <a class="close-slider do-close-slider bps-banner" href="#">
        <img src="{{ url_for('static', filename='images/icons/close-slider.png') }}" alt="close this message">
      </a>
      <div class="columns">
        <img role="presentation" class="bps-banner-image" src="{{ url_for('static', filename='images/icons/smileybones-pixel.png') }}" alt="arXiv smileybones">
        <div class="copy-donation bps-banner">
          <h2>Opt-in to Data Collection for Research</h2>
          <p>arXiv is working with academic researchers to investigate ways to
            improve the service for our users. This requires a rich dataset to
            better inform the research. Users who wish to contribute to the
            future of arXiv may opt in to allow arXiv to use their reading
            data for research purposes. By clicking ‘I agree’ below, you
            consent to your reading data being collected, retained, and
            processed by arXiv and shared with researchers conducting
            research in the public interest. Reading data will never be
            shared publicly or otherwise incorporated into public systems
            in a personally identifiable format. Research use cases include
            developing privacy-preserving recommendation systems for arXiv.
            For more information, see the
            <a target="_blank" href="https://info.arxiv.org/help/policies/privacy_policy.html">
              <b>arXiv Privacy Policy</b></a>.
          </p>
          <p>
            <a id="opt-in-registration" href="#"><strong>I Agree</strong></a>
            <span id="opt-in-enrolled" style="display:none;">
              <strong>ENROLLED</strong> <a id="opt-out" href="#">(OPT OUT?)</a>
            </span>
          </p>
        </div>
      </div>
    </aside>
  {%- endif -%}
{%- endmacro -%}

{# Wrapper content macro #}
{%- macro content(request_datetime) -%}
  {{ banner_1_content(request_datetime) }}
  {{ banner_2_content(request_datetime) }}
{%- endmacro -%}

{%- macro banner_1_script(request_datetime) -%}

  {%- set now=request_datetime.strftime("%Y%m%d%H%M")|int -%}
  {%- if (SLIDE and (BANNER_START_1|int <= now) and (BANNER_END_1|int > now)) -%}

    {# to pass config data to the js #}
    <div 
      id="banner-config"
      data-banner-name="{{ BANNER_1_NAME }}"
      data-banner-end="{{ BANNER_END_1 }}">
    </div>

    {# only run this script while a banner is active #}
    <link rel="stylesheet" type="text/css" media="screen" href="{{ url_for('static', filename='css/slider.css') }}?v=20250312" />
    <script src="//code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/donate.js') }}?v=20250813"></script>
  {%- endif -%}
{%- endmacro -%}

{%- macro banner_2_script(request_datetime) -%}

  {%- set now=request_datetime.strftime("%Y%m%d%H%M")|int -%}
  {%- if (SLIDE and (BANNER_START_2|int <= now) and (BANNER_END_2|int > now)) -%}

    {# to pass config data to the js #}
    <div
      id="banner-config"
      data-banner-name="{{ BANNER_2_NAME }}"
      data-banner-end="{{ BANNER_END_2 }}">
    </div>

    <link rel="stylesheet" type="text/css" media="screen" href="{{ url_for('static', filename='css/slider.css') }}?v=20250312" />
    <script src="//code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/donate.js') }}?v=040725"></script>
    <script>
      function checkOptInParticipation() {
        const cookies = document.cookie;
        const optedIn = cookies.includes('opt-in-tracking');
        const optedOut = cookies.includes('opt-out-tracking');
        const dismissed = cookies.includes('seenBanner_opt-in');


        const banner = document.querySelector('.bps-banner.forum.green');
        const message = banner?.querySelector('.copy-donation p');

        {#
           When the user opts in or out we want to hide the banner and replace
           with some clickable button or icon that will 1) indicate the user's
           opt in status and 2) allow user to change their choice
           (This might also apply to dismissed state)
           # if (banner) banner.style.display = 'none';
        #}

        {# Temporary - until we decide on UI after opt-in selection #}
        if (optedIn) {
          if (message) {
            message.innerHTML = "Thank you for agreeing to participate in "
            + "research by allowing researchers to collect anonymized usage"
            + " data. Your preferences have been saved.";
          }
        }

        {# Temporary - until we decide on UI after opt-out selection #}
        if (optedOut) {
          if (message) {
            message.innerHTML = "Thank you for your response. Your preferences"
            + " have been saved. Click 'I agree' below if you decide to "
            + "participate at a later time.";
          }
        }

        {# Control the opt-in and opt-out actions #}
        if (document.cookie.indexOf('opt-in-tracking') !== -1) {
          document.getElementById('opt-in-registration').style.display = 'none';
          document.getElementById('opt-in-enrolled').style.display = 'inline';
        } else {
          document.getElementById('opt-in-registration').style.display = 'inline';
          document.getElementById('opt-in-enrolled').style.display = 'none';
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        checkOptInParticipation();

        document.getElementById('opt-in-registration').addEventListener('click', function (event) {
          event.preventDefault();
          const uuid = crypto.randomUUID();
          document.cookie = `opt-in-tracking=${uuid}; Path=/; Max-Age=31536000`; // 1 year
          {# Clear opt-in cookie #}
          document.cookie = 'opt-out-tracking=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          checkOptInParticipation();
        });

        document.getElementById('opt-out').addEventListener('click', function (event) {
          event.preventDefault();
          {# Clear opt-in cookie #}
          document.cookie = 'opt-in-tracking=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          {# Set a cookie to indicate the user opted out of data collection. #}
          document.cookie = 'opt-out-tracking=true; Path=/; Max-Age=2592000';

          checkOptInParticipation();
        });
      });
    </script>
  {%- endif -%}
{%- endmacro -%}

{# Wrapper script macro #}
{%- macro script(request_datetime) -%}
  {{ banner_1_script(request_datetime) }}
  {{ banner_2_script(request_datetime) }}
{%- endmacro -%}


<!-- example banner setup

    <aside class="slider-wrapper bps-banner forum blue">
      <a class="do-close-slider close-slider bps-banner" href="#"><img src="{{ url_for('static', filename='images/icons/close-slider.png') }}" alt="close this message"></a>
      <div class="columns">
        <img role="presentation" class="bps-banner-image" src="{{ url_for('static', filename='images/icons/smileybones-infinity-large.png') }}" alt="arXiv Accessibility Forum 2024">
        <div class="copy-donation bps-banner">
          <h2>The Accessibility Forum is back!</h2>
          <p>Coming this September, the Forum is free, virtual, and open to all. <a target="_blank" href="https://cornell.ca1.qualtrics.com/jfe/form/SV_eEZ1d27LF2fVM7Y">Sign Up</a> and <a href="https://accessibility2024.arxiv.org/" target="_blank">Learn more</a>.</p>
        </div>
        <div class="amount-donation bps-banner">
          <div class="donate-cta"><a class="banner_link banner-btn-grad" target="_blank" href="https://cornell.ca1.qualtrics.com/jfe/form/SV_eEZ1d27LF2fVM7Y"><b>Sign Up</b></a></div>
        </div>
      </div>
    </aside>

  -->
